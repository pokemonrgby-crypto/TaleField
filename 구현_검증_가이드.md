# 🎮 TaleField 버그 수정 검증 가이드

## 📋 수정된 문제 목록

이 문서는 최근 수정된 3가지 주요 문제의 검증 방법을 설명합니다.

---

## 1️⃣ 구글 로그인 문제 수정

### 🔍 문제 설명
- 구글 로그인 시 팝업이 차단되면 리다이렉트로 전환되지만, 리다이렉트 결과를 처리하지 않아 로그인이 완료되지 않음
- 오류 메시지가 사용자에게 표시되지 않음

### ✅ 수정 내용
- `getRedirectResult()` 추가하여 페이지 로드 시 리다이렉트 결과 자동 처리
- 팝업 차단 시에만 리다이렉트 사용하도록 개선
- 사용자 친화적인 오류 메시지 추가

### 📝 검증 방법

#### 테스트 1: 팝업 허용 환경
1. 브라우저에서 TaleField 접속
2. "Google 로그인" 버튼 클릭
3. **예상 결과**: 구글 로그인 팝업이 표시되고 로그인 성공

#### 테스트 2: 팝업 차단 환경
1. 브라우저 설정에서 팝업 차단 활성화
2. TaleField 접속
3. "Google 로그인" 버튼 클릭
4. **예상 결과**: 구글 로그인 페이지로 리다이렉트
5. 로그인 후 TaleField로 돌아옴
6. **예상 결과**: 자동으로 로그인 완료 (getRedirectResult 처리)

#### 테스트 3: 오류 처리
1. 로그인 중 팝업 닫기
2. **예상 결과**: 조용히 실패 (사용자가 취소한 경우는 메시지 없음)
3. 네트워크 오류 시뮬레이션 (개발자 도구에서 offline 모드)
4. **예상 결과**: 오류 메시지 표시 "로그인 오류: [오류 내용]"

### 📄 관련 파일
- `public/js/firebase.js`: 로그인 로직 개선

---

## 2️⃣ AI 봇 개수 설정 기능 추가

### 🔍 문제 설명
- 봇 배틀 방 생성 시 봇이 1개로 고정되어 있음
- 여러 봇과 동시에 플레이할 수 없음

### ✅ 수정 내용
- UI에 "봇 개수" 드롭다운 추가 (1~7개 선택 가능)
- 백엔드 `createBotRoom` 함수에서 여러 봇 생성 지원
- 각 봇에 고유 ID 부여 (`bot_1`, `bot_2`, ...)
- 방 제목에 봇 개수 표시

### 📝 검증 방법

#### 테스트 1: 기본 봇 방 생성 (1개)
1. 로비에서 "봇 개수" 드롭다운 확인
2. "1개" 선택 (기본값)
3. 난이도 "보통" 선택
4. "봇과 대결하기" 클릭
5. **예상 결과**: 
   - 방 제목: "봇 배틀 (1봇 vs 1인, NORMAL)"
   - 플레이어 목록에 자신 + 봇 1개 표시
   - 봇 이름: "천계의 수호자 1 (NORMAL)"
   - 봇은 자동으로 준비 완료 상태

#### 테스트 2: 다중 봇 방 생성 (3개)
1. 로비에서 "봇 개수" 드롭다운에서 "3개" 선택
2. 난이도 "어려움" 선택
3. "봇과 대결하기" 클릭
4. **예상 결과**:
   - 방 제목: "봇 배틀 (3봇 vs 1인, HARD)"
   - 플레이어 목록에 자신 + 봇 3개 표시
   - 봇 이름: "천계의 수호자 1 (HARD)", "천계의 수호자 2 (HARD)", "천계의 수호자 3 (HARD)"
   - 모든 봇이 준비 완료 상태

#### 테스트 3: 최대 봇 수 (7개)
1. "봇 개수"에서 "7개" 선택
2. **예상 결과**: 8명 플레이어 방 생성 (자신 1 + 봇 7)
3. 신과 성물 선택 후 준비 완료
4. "게임 시작" 클릭
5. **예상 결과**: 게임이 정상적으로 시작됨

### 📄 관련 파일
- `public/index.html`: 봇 개수 드롭다운 추가
- `public/js/tabs/lobby.js`: 봇 개수를 백엔드로 전송
- `functions/index.js`: `createBotRoom` 함수 개선

---

## 3️⃣ 봇 방 자동 삭제 기능

### 🔍 문제 설명
- 플레이어가 봇 방을 나가도 봇들이 남아있어 방이 삭제되지 않음
- 방 목록에 불필요한 빈 방들이 쌓임

### ✅ 수정 내용
- `leaveRoom` 함수에서 봇 방 감지 로직 추가
- 실제 플레이어(봇이 아닌)가 0명이 되면 방 자동 삭제
- 일반 방과 봇 방을 구분하여 처리

### 📝 검증 방법

#### 테스트 1: 봇 방 나가기
1. 봇 배틀 방 생성 (봇 1~3개)
2. 신과 성물 선택 (준비는 하지 않음)
3. "나가기" 버튼 클릭
4. **예상 결과**:
   - 로비로 이동
   - 방 목록에서 해당 방이 **즉시 사라짐** (봇만 남아있으므로 삭제됨)
   - 콘솔 로그: "봇 방 [roomId]에서 마지막 플레이어가 나갔습니다. 방을 삭제합니다."

#### 테스트 2: 일반 방 나가기 (비교)
1. 일반 방 생성 (봇 없음)
2. 다른 플레이어 없이 혼자 "나가기"
3. **예상 결과**: 
   - 로비로 이동
   - 방이 삭제됨 (마지막 플레이어이므로)

#### 테스트 3: 여러 실제 플레이어가 있는 봇 방
1. 봇 방을 생성하되, 다른 실제 플레이어 1명 추가 (테스트 계정 필요)
2. 방장이 "나가기" 클릭
3. **예상 결과**:
   - 방이 삭제되지 않고 유지됨
   - 다음 실제 플레이어가 방장으로 승격
   - 봇들은 그대로 유지

### 📄 관련 파일
- `functions/index.js`: `leaveRoom` 함수 개선

---

## 4️⃣ 봇 게임 시작 처리 (추가 개선)

### 🔍 문제 설명
- 봇은 Firestore에 신(Shin)과 성물(Artifact) 데이터가 없음
- 게임 시작 시 봇 데이터를 조회하려다 실패함

### ✅ 수정 내용
- 봇 플레이어 감지 시 미리 정의된 봇 덱과 신 사용
- 하드코딩된 봇 데이터로 Firestore 조회 우회
- 매치 플레이어 객체에 `isBot` 플래그 추가

### 📝 검증 방법

#### 테스트 1: 봇 게임 시작
1. 봇 배틀 방 생성
2. 신 선택 + 성물 7개 선택
3. "준비 완료" 클릭
4. **예상 결과**: 봇은 이미 준비 완료 상태
5. "게임 시작" 클릭
6. **예상 결과**:
   - 게임이 정상적으로 시작됨
   - 오류 없이 매치 화면으로 전환
   - 봇의 신 이름: "천계의 수호자"
   - 봇의 손패에 카드 9장 (천계의 검, 화염의 창, 천계의 방패 등)

#### 테스트 2: 봇 턴 확인
1. 게임 시작 후 자신의 턴 종료
2. **예상 결과**: 봇의 턴이 자동으로 진행됨
3. 봇이 카드 사용 또는 기도 액션 수행
4. 게임 로그에 봇의 행동 기록됨

### 📄 관련 파일
- `functions/index.js`: `startGame` 함수 봇 처리 로직 추가
- `data/bot-config.js`: 봇 덱과 신 정의 (참조용)

---

## 🧪 통합 테스트 시나리오

### 시나리오 1: 처음부터 끝까지 봇 게임
1. ✅ 구글 로그인
2. ✅ 닉네임 설정
3. ✅ 신(Shin) 생성
4. ✅ 성물(Artifact) 7개 생성
5. ✅ 봇 배틀 방 생성 (봇 3개, 난이도 보통)
6. ✅ 신과 성물 선택 후 준비 완료
7. ✅ 게임 시작
8. ✅ 봇과 게임 진행
9. ✅ 게임 중 항복 또는 완료
10. ✅ 로비로 복귀

### 시나리오 2: 봇 방 생성 후 바로 나가기
1. ✅ 봇 배틀 방 생성
2. ✅ 바로 "나가기" 클릭
3. ✅ 로비에서 방이 사라진 것 확인

---

## 🚀 배포 전 체크리스트

- [ ] 모든 JavaScript 파일 문법 검증 완료
- [ ] Firebase Functions 로컬 에뮬레이터 테스트
- [ ] 구글 로그인 테스트 (팝업 & 리다이렉트)
- [ ] 봇 1개 방 생성 및 게임 시작 테스트
- [ ] 봇 여러 개 방 생성 및 게임 시작 테스트
- [ ] 봇 방 나가기 테스트
- [ ] 일반 방과 봇 방 동작 차이 확인
- [ ] 콘솔 로그 확인 (오류 없음)

---

## 📌 알려진 제한사항

1. **봇 AI 단순성**: 현재 봇은 매우 기본적인 AI로 동작합니다
   - 무기가 있으면 공격
   - 무기가 없으면 기도
   - 향후 더 똑똑한 AI로 개선 가능

2. **봇 덱 고정**: 모든 봇이 동일한 덱 사용
   - 난이도에 따라 다른 덱을 사용하도록 개선 가능

3. **최대 봇 수**: 현재 7개로 제한
   - 시스템 제한은 없으나, UI와 게임 밸런스를 고려한 제한

---

## 🔧 문제 발생 시 디버깅

### Firebase 콘솔 확인
1. [Firebase Console](https://console.firebase.google.com/) 접속
2. `peaceful-doodad-471301-s2` 프로젝트 선택
3. **Functions** 탭에서 로그 확인
4. **Firestore** 탭에서 rooms 컬렉션 확인

### 브라우저 개발자 도구
1. F12로 개발자 도구 열기
2. **Console** 탭에서 오류 확인
3. **Network** 탭에서 API 호출 확인
4. **Application > IndexedDB** 탭에서 Firestore 캐시 확인

### Eruda 디버그 콘솔 (모바일)
1. URL에 `?debug=true` 추가
2. 화면 우측 하단의 Eruda 아이콘 클릭
3. Console 탭에서 로그 확인

---

## ✅ 수정 완료 항목 요약

| 문제 | 상태 | 파일 |
|------|------|------|
| 구글 로그인 리다이렉트 처리 | ✅ 완료 | `public/js/firebase.js` |
| 봇 개수 선택 UI | ✅ 완료 | `public/index.html` |
| 봇 개수 전송 로직 | ✅ 완료 | `public/js/tabs/lobby.js` |
| 여러 봇 생성 | ✅ 완료 | `functions/index.js` (createBotRoom) |
| 봇 방 자동 삭제 | ✅ 완료 | `functions/index.js` (leaveRoom) |
| 봇 게임 시작 처리 | ✅ 완료 | `functions/index.js` (startGame) |

---

## 📞 문제 보고

문제가 발생하면 다음 정보와 함께 보고해주세요:
1. 브라우저 종류 및 버전
2. 문제 발생 단계
3. 콘솔 오류 메시지 (스크린샷)
4. 재현 방법

---

**작성일**: 2025-10-23  
**버전**: 1.0.0  
**작성자**: GitHub Copilot
