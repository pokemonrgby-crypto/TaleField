# 🎯 TaleField 버그 수정 완료 보고서

## 📋 작업 개요

**프로젝트**: TaleField (갓필드)  
**작업 일시**: 2025-10-23  
**Firebase 프로젝트 ID**: peaceful-doodad-471301-s2  
**작업 내용**: 구글 로그인, AI 봇 개수 설정, 봇 방 자동 삭제 기능 수정

---

## 🔍 수정된 문제 요약

### 1. 구글 로그인 문제
**문제점**: 팝업 차단 시 리다이렉트 로그인 후 결과 처리 안 됨  
**해결**: `getRedirectResult()` 추가로 자동 로그인 완료 처리

### 2. AI 봇 개수 설정 불가
**문제점**: 봇이 1개로 고정되어 있음  
**해결**: UI와 백엔드에 봇 개수 선택 기능 추가 (1~7개)

### 3. 봇 방 자동 삭제 안 됨
**문제점**: 플레이어가 나가도 봇만 남아 방이 유지됨  
**해결**: 실제 플레이어가 0명이 되면 봇 방 자동 삭제

---

## 📝 상세 변경 내역

### 1️⃣ 구글 로그인 개선 (`public/js/firebase.js`)

#### 변경 전
```javascript
export async function signInWithGoogle() {
  try {
    return await signInWithPopup(auth, provider);
  } catch (e) {
    return signInWithRedirect(auth, provider);
  }
}
```

#### 변경 후
```javascript
// getRedirectResult import 추가
import { getRedirectResult, ... } from "firebase/auth";

// 페이지 로드 시 리다이렉트 결과 자동 처리
getRedirectResult(auth)
  .then((result) => {
    if (result) {
      console.log("Google 로그인 성공:", result.user.email);
    }
  })
  .catch((error) => {
    console.error("Google 로그인 리다이렉트 오류:", error);
    // 사용자 친화적인 오류 메시지 표시
    if (error.code === 'auth/popup-blocked') {
      alert('팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용해주세요.');
    } else if (error.code === 'auth/popup-closed-by-user') {
      // 사용자가 팝업을 닫은 경우는 무시
    } else {
      alert(`로그인 오류: ${error.message}`);
    }
  });

export async function signInWithGoogle() {
  try {
    const result = await signInWithPopup(auth, provider);
    console.log("Google 로그인 성공 (팝업):", result.user.email);
    return result;
  } catch (e) {
    console.log("팝업 로그인 실패, 리다이렉트로 전환:", e.code);
    // 팝업이 차단된 경우에만 리다이렉트 사용
    if (e.code === 'auth/popup-blocked' || e.code === 'auth/cancelled-popup-request') {
      return signInWithRedirect(auth, provider);
    }
    throw e;
  }
}
```

**효과**:
- 팝업 차단 환경에서도 정상 로그인 가능
- 리다이렉트 후 자동으로 로그인 완료
- 명확한 오류 메시지로 사용자 경험 개선

---

### 2️⃣ 봇 개수 선택 기능 추가

#### A. UI 수정 (`public/index.html`)

**추가된 요소**:
```html
<label style="color: var(--ink-main);">
  봇 개수:
  <select id="bot-count" style="margin-left: 8px; width: 100px;">
    <option value="1" selected>1개</option>
    <option value="2">2개</option>
    <option value="3">3개</option>
    <option value="4">4개</option>
    <option value="5">5개</option>
    <option value="6">6개</option>
    <option value="7">7개</option>
  </select>
</label>
```

#### B. 프론트엔드 로직 (`public/js/tabs/lobby.js`)

**변경 전**:
```javascript
async function handleCreateBotRoom() {
    const difficulty = botDifficultySelect.value || 'NORMAL';
    const result = await callCreateBotRoom({ 
        difficulty, 
        title: '봇 배틀' 
    });
}
```

**변경 후**:
```javascript
async function handleCreateBotRoom() {
    const difficulty = botDifficultySelect.value || 'NORMAL';
    const botCount = parseInt(botCountSelect?.value || '1', 10);
    const result = await callCreateBotRoom({ 
        difficulty, 
        botCount,
        title: '봇 배틀' 
    });
}
```

#### C. 백엔드 함수 (`functions/index.js`)

**변경된 부분**:
```javascript
export const createBotRoom = functions
  .region("asia-northeast3")
  .https.onCall(async (data, context) => {
    // 스키마 업데이트: botCount 추가
    const { difficulty, botCount, title } = z.object({
      difficulty: z.enum(['EASY', 'NORMAL', 'HARD']).default('NORMAL'),
      botCount: z.number().int().min(1).max(7).default(1), // 새로 추가
      title: z.string().min(2).max(50).default('봇 배틀')
    }).parse(data);

    // 플레이어 배열 생성 (유저 1명 + 봇들)
    const players = [
      { uid, nickname, isHost: true, ready: false, isBot: false, ... }
    ];

    // 봇 플레이어 추가 (반복문으로 여러 봇 생성)
    for (let i = 0; i < botCount; i++) {
      players.push({
        uid: `bot_${i + 1}`,
        nickname: `천계의 수호자 ${i + 1} (${difficulty})`,
        isHost: false,
        ready: true,
        isBot: true,
        shinId: 'bot_shin',
        selectedArtifactIds: []
      });
    }

    // 방 데이터에 botCount 저장
    const roomData = {
      title: `${title} (${botCount}봇 vs 1인, ${difficulty})`,
      maxPlayers: botCount + 1,
      playerUids: [uid, ...Array.from({ length: botCount }, (_, i) => `bot_${i + 1}`)],
      botCount: botCount,
      players: players,
      ...
    };
  });
```

**효과**:
- 사용자가 원하는 만큼 봇 생성 가능 (1~7개)
- 각 봇에 고유 ID와 이름 부여
- 방 제목에 봇 개수 명확히 표시

---

### 3️⃣ 봇 방 자동 삭제 (`functions/index.js`)

**변경 전**:
```javascript
export const leaveRoom = functions.https.onCall(async (data, context) => {
  const players = roomData.players.filter(p => p.uid !== uid);
  
  if (players.length === 0) {
    // 마지막 플레이어가 나가면 방 삭제
    tx.delete(roomRef);
  } else {
    // 플레이어 목록 업데이트
    tx.update(roomRef, { players, ... });
  }
});
```

**변경 후**:
```javascript
export const leaveRoom = functions.https.onCall(async (data, context) => {
  const players = roomData.players.filter(p => p.uid !== uid);
  
  // 실제 플레이어(봇이 아닌) 수를 계산
  const realPlayers = players.filter(p => !p.isBot);
  
  // 봇 방이고 실제 플레이어가 없으면 방 삭제
  if (roomData.isBotRoom && realPlayers.length === 0) {
    console.log(`봇 방 ${roomId}에서 마지막 플레이어가 나갔습니다. 방을 삭제합니다.`);
    tx.delete(roomRef);
    return;
  }
  
  // 모든 플레이어가 나갔으면 방 삭제
  if (players.length === 0) {
    tx.delete(roomRef);
  } else {
    // 방장이 나갔을 경우, 다음 실제 플레이어에게 방장 위임
    if (roomData.hostUid === uid) {
      const nextHost = realPlayers.length > 0 ? realPlayers[0] : players[0];
      updateData.hostUid = nextHost.uid;
      updateData.hostNickname = nextHost.nickname;
      nextHost.isHost = true;
    }
    tx.update(roomRef, updateData);
  }
});
```

**효과**:
- 봇만 남은 방은 즉시 삭제되어 방 목록 정리
- 일반 방은 기존 방식대로 동작
- 방장 위임 로직도 봇을 제외하고 처리

---

### 4️⃣ 봇 게임 시작 처리 (`functions/index.js`)

**추가된 로직**:
```javascript
// startGame 함수 내
if (isGodFieldMode) {
  // 신 정보 가져오기
  const shinPromises = roomData.players.map(p => {
    if (p.isBot) {
      // 봇은 Firestore 조회 없이 null 반환
      return Promise.resolve({ exists: true, data: () => null });
    }
    return db.doc(`shin/${p.shinId}`).get();
  });
  
  // 봇 신 데이터 하드코딩
  const shins = shinSnaps.map((snap, idx) => {
    if (roomData.players[idx].isBot) {
      return {
        name: "천계의 수호자",
        description: "천계를 지키는 강력한 신...",
        uniqueMiracles: [ /* 미리 정의된 기적들 */ ]
      };
    }
    return snap.data();
  });
  
  // 봇 덱 하드코딩
  const allArtifacts = artifactSnaps.flatMap((snap, idx) => {
    if (roomData.players[idx].isBot) {
      return [ /* 미리 정의된 7개 카드 */ ];
    }
    return snap.docs.map(d => d.data());
  });
  
  // 매치 플레이어 객체에 isBot 플래그 추가
  matchPlayers[p.uid] = {
    uid: p.uid,
    nickname: p.nickname,
    isBot: p.isBot || false, // 새로 추가
    hp: 40,
    mp: 10,
    ...
  };
}
```

**효과**:
- 봇 플레이어는 Firestore 조회 없이 게임 시작
- 성능 향상 및 오류 방지
- 봇 덱은 `data/bot-config.js`의 정의를 기반으로 하드코딩

---

## 📊 수정 파일 요약

| 파일 | 변경 내용 | 라인 수 |
|------|----------|---------|
| `public/js/firebase.js` | 로그인 리다이렉트 처리 추가 | +30 |
| `public/index.html` | 봇 개수 선택 UI 추가 | +9 |
| `public/js/tabs/lobby.js` | 봇 개수 전송 로직 | +2 |
| `functions/index.js` | createBotRoom, leaveRoom, startGame 개선 | +120 |
| **총계** | - | **+161** |

---

## ✅ 테스트 결과

### 자동 검증 (완료)
- ✅ JavaScript 문법 검증: 모든 파일 통과
- ✅ Firebase Functions 빌드: 정상
- ✅ 코드 스타일 검사: 정상

### 수동 테스트 (권장)
- [ ] 구글 로그인 (팝업/리다이렉트)
- [ ] 봇 1개 방 생성 및 게임 시작
- [ ] 봇 여러 개 방 생성 및 게임 시작
- [ ] 봇 방 나가기 시 자동 삭제 확인
- [ ] 일반 방 동작 확인 (봇 없음)

---

## 🚀 배포 방법

### Firebase 배포
```bash
# Functions 배포
cd functions
npm install
cd ..
firebase deploy --only functions

# Hosting 배포 (프론트엔드)
firebase deploy --only hosting
```

### 배포 확인
1. [Firebase Console](https://console.firebase.google.com/project/peaceful-doodad-471301-s2) 접속
2. Functions 탭에서 배포 상태 확인
3. Hosting 탭에서 배포된 URL 확인

---

## 📌 알려진 제한사항

1. **봇 AI 단순성**: 현재 봇은 기본적인 규칙 기반 AI
   - 무기 있음 → 공격
   - 무기 없음 → 기도
   
2. **봇 덱 고정**: 모든 봇이 동일한 덱 사용
   - 난이도별 다른 덱은 향후 개선 사항

3. **최대 봇 수 제한**: 7개로 제한
   - 게임 밸런스와 UI 고려

---

## 🔮 향후 개선 사항

### 단기 (1주일)
- [ ] 봇 AI 개선 (확률 기반 → 전략 기반)
- [ ] 난이도별 다른 봇 덱 구성
- [ ] 봇 턴 시각 효과 추가

### 중기 (1개월)
- [ ] 봇과의 멀티플레이 지원 (2인 vs 2봇 등)
- [ ] 봇 프리셋 선택 기능
- [ ] 게임 통계 및 승률 추적

### 장기 (3개월)
- [ ] 머신러닝 기반 봇 AI
- [ ] 토너먼트 모드 (봇 포함)
- [ ] 커스텀 봇 생성 기능

---

## 📞 문제 보고

문제 발생 시 다음 정보와 함께 GitHub Issue에 보고:
1. 브라우저 및 버전
2. 문제 발생 단계
3. 콘솔 오류 메시지
4. 재현 방법

---

## 📚 참고 문서

- [Firebase Authentication Guide](https://firebase.google.com/docs/auth/web/google-signin)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Cloud Functions for Firebase](https://firebase.google.com/docs/functions)

---

**작성일**: 2025-10-23  
**작성자**: GitHub Copilot  
**검토자**: pokemonrgby-crypto  
**상태**: ✅ 구현 완료, 테스트 대기중
