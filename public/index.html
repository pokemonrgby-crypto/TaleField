<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TaleField :: Reborn</title>
  <link rel="stylesheet" href="./style.css">

  <meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://cdn.jsdelivr.net; /* eruda CDN 추가 */
  connect-src 'self'
    https://firestore.googleapis.com
    https://identitytoolkit.googleapis.com
    https://securetoken.googleapis.com
    https://firebaseinstallations.googleapis.com
    https://www.googleapis.com
    https://www.gstatic.com
    https://asia-northeast3-peaceful-doodad-471301-s2.cloudfunctions.net;
  frame-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com;
  img-src 'self' data: https:;
  style-src 'self' 'unsafe-inline';
">
</head>
<body>

  <div id="top-right-container">
    <button id="btn-google" class="btn" style="display:none;">Google 로그인</button>
    <button id="btn-logout" class="btn" style="display:none;">로그아웃</button>
  </div>

  <main>
    <section id="view-lobby" class="active">
      <h1 class="page-title">로비</h1>
      <div class="toolbar">
        <input id="room-title-input" placeholder="방 제목 (2~20자)" maxlength="20" style="flex-grow:1;">
        <button id="btn-create-room" class="btn primary">방 만들기</button>
      </div>

      <div class="bot-battle-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(124,77,255,0.1), rgba(0,212,255,0.1)); border: 1px solid var(--line-main); border-radius: var(--radius-lg);">
        <h3 style="margin-bottom: 12px; color: var(--accent-secondary);">🤖 봇 배틀 (솔로 플레이)</h3>
        <p style="margin-bottom: 16px; color: var(--ink-dim);">AI 봇과 1:1 대결을 펼쳐보세요!</p>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <label style="color: var(--ink-main);">
            난이도:
            <select id="bot-difficulty" style="margin-left: 8px; width: 120px;">
              <option value="EASY">쉬움</option>
              <option value="NORMAL" selected>보통</option>
              <option value="HARD">어려움</option>
            </select>
          </label>
          <button id="btn-create-bot-room" class="btn primary" style="background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));">
            봇과 대결하기
          </button>
        </div>
      </div>

      <ul id="room-list" class="room-list-container"></ul>
      <p id="lobby-status" class="muted"></p>
    </section>

    <section id="view-room">
      <div class="room-header">
        <h1 id="room-title" class="page-title">게임 룸</h1>
        <div>
          <button id="btn-leave-room" class="btn">나가기</button>
          <button id="btn-start-game" class="btn primary large" style="display:none;">게임 시작</button>
        </div>
      </div>
      <div class="room-layout">
        <div class="player-list-container">
            <h3>플레이어</h3>
            <ul id="player-list"></ul>
        </div>
        <div class="selection-container">
          <div id="character-selection-area">
            <h3>신(Shin) 선택</h3>
            <div id="room-my-characters" class="card-grid small"></div>
          </div>
          <div id="skill-selection-area" style="display:none;">
            <h3 id="skill-selection-title">스킬 선택 (2개)</h3>
            <div id="room-my-skills"></div>
          </div>
        </div>
        <div class="card-selection-container">
            <h3>천계 덱에 제출할 성물 (정확히 7개 선택)</h3>
            <p class="muted">현재 <span id="room-selected-card-count">0</span>개 선택됨</p>
            <div id="room-my-cards" class="card-grid small"></div>
            <button id="btn-ready" class="btn primary" style="margin-top: 16px;">준비 완료</button>
        </div>
      </div>
    </section>

    <section id="view-match">
      <div class="match-header">
          <h1 id="match-title" class="page-title">게임 중</h1>
          <div>
              <button id="btn-surrender" class="btn danger">항복</button>
          </div>
      </div>
      <div class="match-grid-layout">
        <div id="match-log-panel" class="match-panel">
            <h3>필드 (게임 로그)</h3>
            <div id="match-log" class="game-log"></div>
        </div>
        <div id="match-players-panel" class="match-panel">
            <h3>플레이어 상태</h3>
            <div id="match-player-list"></div>
            <div id="my-player-state">
                <div class="player-stats">
                    <div class="stat-row">
                        <span>HP:</span> <span id="my-hp">40/40</span>
                    </div>
                    <div class="stat-row">
                        <span>MP:</span> <span id="my-mp">10/10</span>
                    </div>
                    <div class="stat-row">
                        <span>Gold:</span> <span id="my-gold">20/20</span>
                    </div>
                </div>
                <div id="my-equipment-panel" class="equipment-panel">
                    <h4>장비</h4>
                    <div class="equipment-slots">
                        <div class="equipment-slot" data-slot="weapon">
                            <span class="slot-label">⚔️ 무기:</span>
                            <span id="equipment-weapon" class="slot-value">없음</span>
                        </div>
                        <div class="equipment-slot" data-slot="shield">
                            <span class="slot-label">🛡️ 방패:</span>
                            <span id="equipment-shield" class="slot-value">없음</span>
                        </div>
                        <div class="equipment-slot" data-slot="accessory">
                            <span class="slot-label">💎 장신구:</span>
                            <span id="equipment-accessory" class="slot-value">없음</span>
                        </div>
                    </div>
                </div>
                <div id="my-disasters-panel" class="disasters-panel">
                    <h4>재앙</h4>
                    <div id="my-disasters" class="disasters-list">없음</div>
                </div>
            </div>
        </div>
        <div id="match-miracles-panel" class="match-panel">
            <h3>기적 목록</h3>
            <div id="my-miracles" class="card-grid small">
                <p class="muted">고유 기적이 여기에 표시됩니다.</p>
            </div>
        </div>
        <div id="match-hand-panel" class="match-panel">
            <h3>내 손패</h3>
            <div id="my-hand" class="card-grid small"></div>
        </div>
        <div id="match-actions-panel" class="match-panel">
            <h3>상세 정보 및 액션</h3>
            <div id="selected-card-details">
                <p class="muted">카드를 선택하면 정보가 표시됩니다.</p>
            </div>
            <div id="match-actions" class="actions-panel">
                <div class="target-info">
                    선택한 카드: <span id="selected-card-name">없음</span><br>
                    선택한 대상: <span id="selected-target-name">없음</span>
                </div>
                <div class="action-buttons">
                    <button id="btn-play-card" class="btn primary" disabled>카드 사용</button>
                    <button id="btn-end-turn" class="btn">턴 종료</button>
                </div>
                <div id="godfield-actions" class="godfield-actions" style="margin-top: 12px; display: none;">
                    <h4 style="margin-bottom: 8px;">GodField 액션</h4>
                    <div class="action-buttons">
                        <button id="btn-attack" class="btn primary" disabled>⚔️ 공격</button>
                        <button id="btn-defend" class="btn primary" disabled>🛡️ 방어</button>
                        <button id="btn-pray" class="btn" disabled>🙏 기도</button>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </section>

    <section id="view-my-characters">
        <h1 class="page-title">내 신(Shin)</h1>
        <div class="toolbar">
            <button id="btn-refresh-my-chars" class="btn">새로고침</button>
            <span id="my-chars-status" class="muted">내가 생성한 신 목록입니다.</span>
        </div>
        <div id="my-chars-grid" class="card-grid"></div>
    </section>

    <section id="view-my-cards">
        <h1 class="page-title">내 성물(Artifact)</h1>
        <div class="toolbar">
            <button id="btn-refresh-my-cards" class="btn">새로고침</button>
            <span id="my-cards-status" class="muted">내가 생성한 성물 목록입니다.</span>
        </div>
        <div id="my-cards-grid" class="card-grid"></div>
    </section>

    <section id="view-gen-hub">
      <h1 class="page-title">생성</h1>
      <div class="gen-hub-container">
        <div class="gen-hub-item" id="btn-goto-gen-char">
          <h2>AI 신(Shin) 생성</h2>
          <p>AI의 도움을 받아 예언자를 후원할 강력한 신과 고유 기적을 창조하세요.</p>
        </div>
        <div class="gen-hub-item" id="btn-goto-gen-card">
          <h2>AI 성물(Artifact) 생성</h2>
          <p>독창적인 아이디어로 새로운 성물을 만들어 천계 덱을 풍성하게 하세요.</p>
        </div>
      </div>
    </section>

    <section id="view-gen-char">
        <div class="page-header">
          <button class="btn btn-back" data-target="view-gen-hub">&lt; 뒤로가기</button>
          <h1 class="page-title">AI 신(Shin) 생성</h1>
        </div>
        <div class="toolbar">
          <textarea id="gen-char-prompt" placeholder="만들고 싶은 신의 아이디어를 150자 내로 자유롭게 적어주세요. (예: 명왕신 하데스, 죽음과 암흑을 다스리는 과묵한 신)" maxlength="150"></textarea>
          <label>창의성 <input id="gen-char-temp" type="number" step="0.1" min="0" max="1" value="0.8" style="width:80px"></label>
          <button id="btn-gen-char" class="btn primary">Generate (1명)</button>
          <span id="gen-char-status" class="muted"></span>
        </div>
        <div id="gen-char-results" class="card-grid"></div>
    </section>

    <section id="view-gen">
      <div class="page-header">
        <button class="btn btn-back" data-target="view-gen-hub">&lt; 뒤로가기</button>
        <h1 class="page-title">AI 성물(Artifact) 생성</h1>
      </div>
      <div class="toolbar">
        <textarea id="gen-prompt" placeholder="만들고 싶은 성물의 아이디어를 150자 내로 자유롭게 적어주세요. (예: 승천궁, 빛 속성의 자폭형 무기)" maxlength="150"></textarea>
        <label>창의성 <input id="gen-temp" type="number" step="0.1" min="0" max="1" value="0.8" style="width:80px"></label>
        <button id="btn-gen-cards" class="btn primary">Generate (1개)</button>
        <span id="gen-status" class="muted"></span>
      </div>
      <div id="gen-results" class="card-grid"></div>
    </section>
  </main>

  <nav class="bottom-nav">
    <div class="bottom-nav__tabs">
      <button data-tab="view-lobby" class="active">로비</button>
      <button data-tab="view-my-characters">내 신</button>
      <button data-tab="view-my-cards">내 성물</button>
      <button data-tab="view-gen-hub">생성</button>
    </div>
  </nav>

  <div id="nickname-modal" style="display:none;">
    <div class="card">
      <div class="card__body">
        <h3>닉네임 설정</h3>
        <p class="muted">게임에서 사용할 닉네임을 입력해주세요.</p>
        <input id="nickname-input" maxlength="12" placeholder="2~12자 닉네임" style="width:100%; margin: 10px 0;" />
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <button id="nickname-save" class="btn primary">저장</button>
          <span id="nickname-error" class="danger"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/firebase-config.js"></script>
  <script type="module" src="./js/app.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    // URL 파라미터에 debug=true가 있거나, 로컬 환경일 때만 eruda 활성화
    const urlParams = new URLSearchParams(window.location.search);
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    if (urlParams.get('debug') === 'true' || isLocal) {
      eruda.init();
      console.log('Eruda debug console activated.');
    }
  </script>
  </body>
</html>
