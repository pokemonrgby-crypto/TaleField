# Firebase 배포 오류 해결 완료

## 문제

Firebase Functions 배포 시 다음과 같은 오류가 발생했습니다:

```
Error: In non-interactive mode but have no value for the following secrets: GEMINI_API_KEY
Set these secrets before deploying:
    firebase functions:secrets:set GEMINI_API_KEY
Error: Process completed with exit code 1.
```

Google Cloud Console에서 `GEMINI_API_KEY` 시크릿을 올바르게 설정하고 권한도 제대로 설정했음에도 불구하고 계속 오류가 발생했습니다.

## 원인

문제의 핵심은 **GitHub Actions 워크플로우가 배포 시 GEMINI_API_KEY 시크릿을 Google Cloud Secret Manager에 자동으로 설정하지 않았기 때문**입니다.

Firebase Functions에서 `functions.params.defineSecret("GEMINI_API_KEY")`를 사용하면, 배포 시점에 해당 시크릿이 Google Cloud Secret Manager에 이미 존재해야 합니다. 하지만 기존 워크플로우는 이 설정 단계를 포함하지 않았습니다.

## 해결 방법

`.github/workflows/firebase-deploy.yml` 파일을 수정하여 다음 두 가지를 추가했습니다:

### 1. GEMINI_API_KEY 검증 추가

```yaml
check "${{ secrets.GEMINI_API_KEY }}" GEMINI_API_KEY
```

배포 전에 GitHub Secrets에 GEMINI_API_KEY가 설정되어 있는지 확인합니다.

### 2. 배포 전 시크릿 자동 설정

```yaml
- name: Set Firebase Functions secrets
  env:
    FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
    GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  run: |
    if [ -d "functions" ]; then
      echo "Setting GEMINI_API_KEY secret..."
      echo "$GEMINI_API_KEY" | firebase functions:secrets:set GEMINI_API_KEY --project "$FIREBASE_PROJECT_ID" --force
    fi
```

Firebase 배포 전에 자동으로 `firebase functions:secrets:set` 명령을 실행하여 Google Cloud Secret Manager에 GEMINI_API_KEY를 설정합니다.

## 다음 단계

### ⚠️ 중요: PR 머지 전 확인 사항

1. **GitHub Secrets 설정 확인**
   - GitHub 저장소 → Settings → Secrets and variables → Actions
   - `GEMINI_API_KEY` 시크릿이 있는지 확인
   - 없다면 추가 (실제 Gemini API 키 값 사용)

2. **GCP 서비스 계정 권한 확인**
   - `GCP_SA_KEY`에 설정된 서비스 계정이 Secret Manager를 관리할 수 있는 권한이 있는지 확인
   - 필요한 역할: `roles/secretmanager.admin` 또는 그에 상응하는 권한

### 테스트 방법

1. 이 PR을 main 브랜치에 머지
2. GitHub Actions가 자동으로 실행됨
3. 워크플로우 로그에서 "Setting GEMINI_API_KEY secret..." 메시지 확인
4. 배포가 성공적으로 완료되는지 확인

## 변경된 파일

- `.github/workflows/firebase-deploy.yml`: 워크플로우 수정 (12줄 추가)
- `GEMINI_API_KEY_FIX.md`: 상세 문서 (한국어)
- `해결완료_요약.md`: 이 파일 (간단 요약)

## 추가 정보

더 자세한 정보는 `GEMINI_API_KEY_FIX.md` 파일을 참조하세요.
